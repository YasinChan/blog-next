<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <meta name="keywords" content="typing, enter, beforeinput, Fisher-Yates, CompositionEvent, beforeinput, 正则"><meta name="description" content="https://typing.yasinchan.com/ 字符输入逻辑介绍"><link rel="icon" href="https://file.yasinchan.com/rPAaaJxvP0KoTDILIYwSfGxWjUT51d8X/D018B6FFE06A79F3EE14730D88214BEE.png"><script src="/iconfont.js"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7a4553a66f119e8706760cec79cafbbf";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-8C7G0NW5CR"></script><script> window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8C7G0NW5CR');</script><title>Typing 项目技术总结 - 字符输入逻辑 | YasinChan 的博客</title>
    <link rel="preload" href="/assets/style-DtFysu9h.css" as="style"><link rel="stylesheet" href="/assets/style-DtFysu9h.css">
    <link rel="modulepreload" href="/assets/app-Ck2BnQe9.js"><link rel="modulepreload" href="/assets/typing-enter.html-Bxm9quvM.js">
    <link rel="prefetch" href="/assets/index.html-CNovLDqH.js" as="script"><link rel="prefetch" href="/assets/blog.html-Bzd53X_Z.js" as="script"><link rel="prefetch" href="/assets/me.html-DOCzVnhH.js" as="script"><link rel="prefetch" href="/assets/about-slate.html-BXNyS_vS.js" as="script"><link rel="prefetch" href="/assets/callback-hell.html-Ark66SlT.js" as="script"><link rel="prefetch" href="/assets/git-push.html-CuoCVwDz.js" as="script"><link rel="prefetch" href="/assets/git-submodule.html-DTBV30vE.js" as="script"><link rel="prefetch" href="/assets/html-different-space-slate.html-OC0KaHi3.js" as="script"><link rel="prefetch" href="/assets/nginx-gzip.html-CyBYsRoP.js" as="script"><link rel="prefetch" href="/assets/regexp-test-exec.html-DuwwASpi.js" as="script"><link rel="prefetch" href="/assets/slate-after-entering-a.html-BTBU69P1.js" as="script"><link rel="prefetch" href="/assets/typing-change-font.html-CtT_MO0v.js" as="script"><link rel="prefetch" href="/assets/typing-game.html-BdZeeImr.js" as="script"><link rel="prefetch" href="/assets/typing-intr.html-BmbF4xTo.js" as="script"><link rel="prefetch" href="/assets/vetur-vue-error.html-CVYoN2so.js" as="script"><link rel="prefetch" href="/assets/word-break-word-break.html-Dw5Ig3-9.js" as="script"><link rel="prefetch" href="/assets/zero-width-space.html-BahI9JDL.js" as="script"><link rel="prefetch" href="/assets/404.html-8P4-zOUP.js" as="script"><link rel="prefetch" href="/assets/index.html-fWEbc_TZ.js" as="script"><link rel="prefetch" href="/assets/index.html-B2VK79qD.js" as="script"><link rel="prefetch" href="/assets/index.html-DSPwj6Pc.js" as="script"><link rel="prefetch" href="/assets/index.html-BL0Y15Un.js" as="script"><link rel="prefetch" href="/assets/index.html-B7zhFJWN.js" as="script"><link rel="prefetch" href="/assets/index.html-D8CZE5A5.js" as="script"><link rel="prefetch" href="/assets/index.html-D_ZjJ96F.js" as="script"><link rel="prefetch" href="/assets/index.html-74oRnf-N.js" as="script"><link rel="prefetch" href="/assets/index.html-CiH9SZNK.js" as="script"><link rel="prefetch" href="/assets/index.html-C9-e1YP3.js" as="script"><link rel="prefetch" href="/assets/index.html-Cd7YmJjP.js" as="script"><link rel="prefetch" href="/assets/index.html-B_XzezL0.js" as="script"><link rel="prefetch" href="/assets/index.html-BZ1EMenC.js" as="script"><link rel="prefetch" href="/assets/index.html-CWvMnOv_.js" as="script"><link rel="prefetch" href="/assets/index.html-BHRuEpbo.js" as="script"><link rel="prefetch" href="/assets/index.html-_SRoCKTN.js" as="script"><link rel="prefetch" href="/assets/index.html-DsRFuLFu.js" as="script"><link rel="prefetch" href="/assets/index.html-BvbuF1st.js" as="script"><link rel="prefetch" href="/assets/index.html-DzR_fULM.js" as="script"><link rel="prefetch" href="/assets/index.html-fNfPnZOu.js" as="script"><link rel="prefetch" href="/assets/index.html-DS5Kh_vx.js" as="script"><link rel="prefetch" href="/assets/index.html-QGQRPcoG.js" as="script"><link rel="prefetch" href="/assets/index.html-Dv9X3oL2.js" as="script"><link rel="prefetch" href="/assets/index.html-DGP_QEmv.js" as="script"><link rel="prefetch" href="/assets/index.html-CT44rxNl.js" as="script"><link rel="prefetch" href="/assets/index.html-DP6m1dv0.js" as="script"><link rel="prefetch" href="/assets/index.html-DWy31x4x.js" as="script"><link rel="prefetch" href="/assets/index.html-CsrEo3PF.js" as="script"><link rel="prefetch" href="/assets/index.html-C6AOkSrh.js" as="script"><link rel="prefetch" href="/assets/index.html-C53Ufrj6.js" as="script"><link rel="prefetch" href="/assets/index.html-Dj6gyOW1.js" as="script"><link rel="prefetch" href="/assets/index.html-CQ9EL_ez.js" as="script"><link rel="prefetch" href="/assets/index.html-99NUFztv.js" as="script"><link rel="prefetch" href="/assets/index.html-CCRj9nJV.js" as="script"><link rel="prefetch" href="/assets/index.html-CRV5DF-m.js" as="script"><link rel="prefetch" href="/assets/SearchResult-BiPen5Rz.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="logo" src="https://file.yasinchan.com/rPAaaJxvP0KoTDILIYwSfGxWjUT51d8X/D018B6FFE06A79F3EE14730D88214BEE.png" alt="YasinChan 的博客"><span class="site-name can-hide" aria-hidden="true">YasinChan 的博客</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="route-link route-link-active" href="/post/" aria-label="博客"><!--[--><!--]--> 博客 <!--[--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/tags/" aria-label="标签"><!--[--><!--]--> 标签 <!--[--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/archives/" aria-label="归档"><!--[--><!--]--> 归档 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="关于"><span class="title">关于</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="关于"><span class="title">关于</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="route-link" href="/about/blog.html" aria-label="此博客"><!--[--><!--]--> 此博客 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="route-link" href="/about/me.html" aria-label="我"><!--[--><!--]--> 我 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="好玩"><span class="title">好玩</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="好玩"><span class="title">好玩</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://qm.yasinchan.com" rel="noopener noreferrer" target="_blank" aria-label="Quick Meet"><!--[--><!--]--> Quick Meet <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://typing.yasinchan.com" rel="noopener noreferrer" target="_blank" aria-label="Typing"><!--[--><!--]--> Typing <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/yasinchan" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="route-link route-link-active" href="/post/" aria-label="博客"><!--[--><!--]--> 博客 <!--[--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/tags/" aria-label="标签"><!--[--><!--]--> 标签 <!--[--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/archives/" aria-label="归档"><!--[--><!--]--> 归档 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="关于"><span class="title">关于</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="关于"><span class="title">关于</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="route-link" href="/about/blog.html" aria-label="此博客"><!--[--><!--]--> 此博客 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="route-link" href="/about/me.html" aria-label="我"><!--[--><!--]--> 我 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="好玩"><span class="title">好玩</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="好玩"><span class="title">好玩</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://qm.yasinchan.com" rel="noopener noreferrer" target="_blank" aria-label="Quick Meet"><!--[--><!--]--> Quick Meet <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://typing.yasinchan.com" rel="noopener noreferrer" target="_blank" aria-label="Typing"><!--[--><!--]--> Typing <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/yasinchan" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Typing 项目技术总结 - 字符输入逻辑 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#文案渲染" aria-label="文案渲染"><!--[--><!--]--> 文案渲染 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#输入框" aria-label="输入框"><!--[--><!--]--> 输入框 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#compositionevent-和-beforeinput" aria-label="CompositionEvent 和 beforeinput"><!--[--><!--]--> CompositionEvent 和 beforeinput <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#监听输入事件用于记录内容用于错误统计和回放功能" aria-label="监听输入事件用于记录内容用于错误统计和回放功能"><!--[--><!--]--> 监听输入事件用于记录内容用于错误统计和回放功能 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#禁用部分输入和键盘事件-避免干扰" aria-label="禁用部分输入和键盘事件，避免干扰"><!--[--><!--]--> 禁用部分输入和键盘事件，避免干扰 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="#文案与输入内容绑定" aria-label="文案与输入内容绑定"><!--[--><!--]--> 文案与输入内容绑定 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#限时模式、计时模式、自定义模式下的特定逻辑和输入组件的绑定逻辑" aria-label="限时模式、计时模式、自定义模式下的特定逻辑和输入组件的绑定逻辑"><!--[--><!--]--> 限时模式、计时模式、自定义模式下的特定逻辑和输入组件的绑定逻辑 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#fisher-yates-洗牌算法" aria-label="Fisher-Yates 洗牌算法"><!--[--><!--]--> Fisher-Yates 洗牌算法 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#上传文档" aria-label="上传文档"><!--[--><!--]--> 上传文档 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="#其他个性化功能逻辑" aria-label="其他个性化功能逻辑"><!--[--><!--]--> 其他个性化功能逻辑 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#标点符号和空格的相互转换功能" aria-label="标点符号和空格的相互转换功能"><!--[--><!--]--> 标点符号和空格的相互转换功能 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="typing-项目技术总结-字符输入逻辑" tabindex="-1"><a class="header-anchor" href="#typing-项目技术总结-字符输入逻辑"><span>Typing 项目技术总结 - 字符输入逻辑</span></a></h1><p>地址：<a href="https://typing.yasinchan.com" target="_blank" rel="noopener noreferrer">https://typing.yasinchan.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>源码：<a href="https://github.com/YasinChan/typing" target="_blank" rel="noopener noreferrer">https://github.com/YasinChan/typing<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><img src="https://file.yasinchan.com/nS2xPufcI5TKM93b4N4a91oDAbPavS6F/2559139329.png" alt=""></p><p>这是整个 <a href="https://typing.yasinchan.com/" target="_blank" rel="noopener noreferrer">Typing<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 最重要的一个模块，主要逻辑可以查看<a href="https://github.com/YasinChan/typing/blob/main/src/components/WordInput.vue" target="_blank" rel="noopener noreferrer">文件路径<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p>主要涉及到几个点：</p><ul><li>文案渲染</li><li>输入框</li><li>文案与输入内容绑定</li><li>限时模式、计时模式、自定义模式下的特定逻辑和输入组件的绑定逻辑</li><li>其他个性化功能逻辑</li></ul><h2 id="文案渲染" tabindex="-1"><a class="header-anchor" href="#文案渲染"><span>文案渲染</span></a></h2><p>在这里我定义了一个 <a href="https://github.com/YasinChan/typing/blob/main/src/files/Quote.json" target="_blank" rel="noopener noreferrer">JSON 文件<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>用来储存文案，结构如下</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;long&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;散文&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;length&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xxx&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;medium&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;散文&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;length&quot;</span><span class="token operator">:</span> <span class="token string">&quot;medium&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;content&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;short&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;片段&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;length&quot;</span><span class="token operator">:</span> <span class="token string">&quot;short&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;content&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到我分为了三种长度的文案类型，方便用户选择，在这文案的基础上的逻辑开发过程如下：</p><p>需要明确的逻辑是用户在输入过程中，是需要记录已输入、输入错误、未输入的记录的，同时用户输入过程中的每个字都需要同步反映到文案上，所以文案中每个字都需要单独控制，所以我通过以下方式渲染到 HTML 上，代码查看<a href="https://github.com/YasinChan/typing/blob/e98a68a4cbe5c766d4ae260423bbac3814398b88/src/components/WordInput.vue#L431" target="_blank" rel="noopener noreferrer">文件路径<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token comment">&lt;!-- vue template 语法--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>y-word-input__quote<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>
    <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item in state.quoteArr<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[item.isWrong ? &#39;is-wrong&#39; : &#39;&#39;, item.isInput ? &#39;is-input&#39; : &#39;&#39;]<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item.id<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span>{{ item.word }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span>
  <span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看出每个字都被 <code>&lt;span&gt;</code> 包裹，这样可以在每个 <code>&lt;span&gt;</code>上通过 <strong>class</strong> <code>is-wrong</code> 和 <code>is-input</code> 来达到不同状态的样式呈现。</p><h2 id="输入框" tabindex="-1"><a class="header-anchor" href="#输入框"><span>输入框</span></a></h2><p>输入框是基于 <strong>div contenteditable</strong> 实现，与上述渲染的文案排版逻辑是通过将两者的 <code>line-height</code> 设置为 <strong>70px</strong>，然后通过绝对定位的方式层叠渲染，使彼此的内容恰好在文案间隙中，达到流畅换行的目的。</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
  <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputAreaRef<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@paste</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pasteEvent<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@keydown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>keyDownEvent<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputEvent<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@mousedown.prevent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mouseDownEvent<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@mouseup.prevent</span>
  <span class="token attr-name">@beforeinput</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beforeInputEvent<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@compositionstart</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>compositionStartEvent<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@compositionupdate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>compositionUpdateEvent<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@compositionend</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>compositionEndEvent<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>y-word-input__input-area<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">contenteditable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过代码可以看到这里绑定了很多事件，这里主要目的是两个</p><ol><li>监听输入事件用于记录内容用于错误统计和回放功能</li><li>粘贴、撤销、反撤销、键盘选中等事件都需要取消掉，避免干扰情况</li></ol><p>关于第一点，先引入 **<code>CompositionEvent</code>**和 <code>beforeinput</code> 的概念</p><h3 id="compositionevent-和-beforeinput" tabindex="-1"><a class="header-anchor" href="#compositionevent-和-beforeinput"><span><strong>CompositionEvent</strong> 和 <strong>beforeinput</strong></span></a></h3><blockquote><p>DOM 接口  <strong><code>CompositionEvent</code></strong>  表示用户间接输入文本（如使用输入法）时发生的事件。此接口的常用事件有 <code>compositionstart</code>, <code>compositionupdate</code> 和  <code>compositionend</code></p></blockquote><p>这是 MDN 的解释，简单来说，比如搜狗输入法这种 <strong>IME</strong> ，可以将键盘上的字母转换成中文，当我们在使用这类 IME 时，浏览器提供了 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CompositionEvent" target="_blank" rel="noopener noreferrer">CompositionEvent<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 相关事件，</p><ul><li>当我们开始输入组合字符，会触发 <code>compositionstart</code> ，</li><li>在输入过程中会持续触发 <code>compositionupdate</code> ，</li><li>当完成时，比如按下空格或者回车等，则会触发 <code>compositionend</code> 。</li></ul><blockquote><p>DOM 事件 <strong><code>beforeinput</code></strong>  在<code>[&lt;input&gt;]</code>, <code>&lt;select&gt;</code>  或  <code>&lt;textarea&gt;</code> 的值即将被修改前触发。这个事件也可以在  <code>contenteditable</code>  被设置为 <code>true</code> 的元素和打开  <code>designMode</code>  后的任何元素上被触发。</p></blockquote><p>这是 MDN 对 <code>beforeinput</code> 的解释，就是说当输入一个字符，当被渲染到浏览器之前会触发这个事件，这个事件常作为现代富文本编辑器的核心事件，如 <a href="https://github.com/ianstormtaylor/slate" target="_blank" rel="noopener noreferrer">slate<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 等。</p><h3 id="监听输入事件用于记录内容用于错误统计和回放功能" tabindex="-1"><a class="header-anchor" href="#监听输入事件用于记录内容用于错误统计和回放功能"><span>监听输入事件用于记录内容用于错误统计和回放功能</span></a></h3><p>这个功能在下一篇文章中将会提到，这里先简要说一下相关逻辑：</p><p>这里的逻辑中除了需要记录中英文，还需要记录在 <strong>composition</strong> 状态下的英文。用到的事件是 <code>input</code> <code>beforeinput</code> <code>compositionstart</code> <code>compositionupdate</code> <code>compositionend</code> ，英文输入相关是通过 <code>input</code> 进行记录，中文输入会在 <code>compositionend</code> 中记录，然后通过 <code>CompositionEvent</code> 结合 <code>beforeinput</code> 可以记录下在 composition 状态下的英文了。</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">beforeInputEvent</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>isTyping <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>inputType <span class="token operator">===</span> <span class="token string">&#39;insertCompositionText&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>compositionList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处于 composition 状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>currentComposition <span class="token operator">===</span> e<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\w+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里是 composition 状态结束的条件，比如按了空格、回车。</span>
      state<span class="token punctuation">.</span>isComposing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      state<span class="token punctuation">.</span>currentComposition <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    state<span class="token punctuation">.</span>currentComposition <span class="token operator">=</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>inputType <span class="token operator">===</span> <span class="token string">&#39;deleteContentBackward&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>currentComposition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果在 composition 状态下鼠标点了旁边，这时 composition 状态下的输入会被删除，此时只需要将 currentComposition 清空即可。</span>
      state<span class="token punctuation">.</span>currentComposition <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外在输入过程中还定义了两个列表，用于做一些特殊字符过滤处理。</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">const</span> whiteList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;”&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;》&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;}&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;）&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;】&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;’&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 白名单，这些字符不会被标记为错误</span>
<span class="token keyword">const</span> compositionList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;“”&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;《》&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;{}&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;（）&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;【】&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;‘’&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// composition 状态下的字符</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="禁用部分输入和键盘事件-避免干扰" tabindex="-1"><a class="header-anchor" href="#禁用部分输入和键盘事件-避免干扰"><span>禁用部分输入和键盘事件，避免干扰</span></a></h3><p>上面说到的第二点，在输入期间，为确保输入过程不被其他情况干扰，这里会将比如粘贴事件、选择事件等都禁用。</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">pasteEvent</span><span class="token punctuation">(</span>e<span class="token operator">:</span> ClipboardEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">keyDownEvent</span><span class="token punctuation">(</span>e<span class="token operator">:</span> KeyboardEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;keydown-event&#39;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token constant">KEY_CODE_ENUM</span><span class="token punctuation">[</span><span class="token string">&#39;ENTER&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">.</span>isSpaceType <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>props<span class="token punctuation">.</span>canSpace <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token constant">KEY_CODE_ENUM</span><span class="token punctuation">[</span><span class="token string">&#39;SPACE&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    e<span class="token punctuation">.</span>shiftKey <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token constant">KEY_CODE_ENUM</span><span class="token punctuation">[</span><span class="token string">&#39;ARROW_LEFT&#39;</span><span class="token punctuation">]</span> <span class="token operator">||</span> e<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token constant">KEY_CODE_ENUM</span><span class="token punctuation">[</span><span class="token string">&#39;ARROW_RIGHT&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// shift + 左右方向键禁止</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>metaKey <span class="token operator">||</span> e<span class="token punctuation">.</span>ctrlKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token constant">KEY_CODE_ENUM</span><span class="token punctuation">[</span><span class="token string">&#39;KEY_A&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ctrl + a 禁止 或者 command + a 禁止</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>metaKey <span class="token operator">||</span> e<span class="token punctuation">.</span>ctrlKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token constant">KEY_CODE_ENUM</span><span class="token punctuation">[</span><span class="token string">&#39;KEY_Z&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ctrl + z 禁止 或者 command + z 禁止</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>metaKey <span class="token operator">||</span> e<span class="token punctuation">.</span>ctrlKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token constant">KEY_CODE_ENUM</span><span class="token punctuation">[</span><span class="token string">&#39;BACKSPACE&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ctrl + back space 禁止 或者 command + back space 禁止</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同时通过禁用 mouse 相关事件，将鼠标选择事件也禁用掉。</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code>@mousedown.prevent @mouseup.prevent
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>不过这会导致如果输入框失焦，那么也将无法通过鼠标点击来 focus。因此，这里在 mousedown 上还需要加上一个逻辑</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">focusInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputAreaRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  inputAreaRef<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">moveCaretToEnd</span><span class="token punctuation">(</span>inputAreaRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">moveCaretToEnd</span><span class="token punctuation">(</span>element<span class="token operator">:</span> HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使光标移动到末尾</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>createRange <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>getSelection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> range <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> selection <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    range<span class="token punctuation">.</span><span class="token function">selectNodeContents</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    range<span class="token punctuation">.</span><span class="token function">collapse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selection <span class="token operator">&amp;&amp;</span> selection<span class="token punctuation">.</span><span class="token function">removeAllRanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selection <span class="token operator">&amp;&amp;</span> selection<span class="token punctuation">.</span><span class="token function">addRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// @ts-ignore</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>createTextRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// For older IE</span>
    <span class="token comment">// @ts-ignore</span>
    <span class="token keyword">const</span> range <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">createTextRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    range<span class="token punctuation">.</span><span class="token function">moveToElementText</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    range<span class="token punctuation">.</span><span class="token function">collapse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    range<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用于点击输入框时，光标直接在末尾呈现。</p><h2 id="文案与输入内容绑定" tabindex="-1"><a class="header-anchor" href="#文案与输入内容绑定"><span>文案与输入内容绑定</span></a></h2><p>上面所说的用于渲染文案的数据结构是这样的</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">type</span> <span class="token class-name">SentenceArrItem</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  word<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  isInput<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  isWrong<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  quoteArr<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">as</span> SentenceArrItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>相关 <code>input</code> <code>beforeinput</code> <code>composition</code> 事件触发时会改变 <code>state.inputText</code> 的内容，</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token function">watch</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>inputText<span class="token punctuation">,</span>
  <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> inputTextArr <span class="token operator">=</span> newVal<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> wrongPos<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>quoteArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span>isInput <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      item<span class="token punctuation">.</span>isWrong <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>inputTextArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span>isInput <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>isWrong <span class="token operator">=</span> item<span class="token punctuation">.</span>word <span class="token operator">!==</span> inputTextArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>isWrong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          wrongPos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>whiteList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>inputTextArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          item<span class="token punctuation">.</span>isInput <span class="token operator">=</span> item<span class="token punctuation">.</span>word <span class="token operator">===</span> inputTextArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
          item<span class="token punctuation">.</span>isWrong <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后 <code>watch state.inputText</code>，在其中对 <code>state.quoteArr</code> 进行改变，最终触发文案渲染的改变。</p><h2 id="限时模式、计时模式、自定义模式下的特定逻辑和输入组件的绑定逻辑" tabindex="-1"><a class="header-anchor" href="#限时模式、计时模式、自定义模式下的特定逻辑和输入组件的绑定逻辑"><span>限时模式、计时模式、自定义模式下的特定逻辑和输入组件的绑定逻辑</span></a></h2><p>在完成以上功能之后，组件会在不同阶段 emit 出一些事件，用于业务逻辑的处理</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">const</span> emit <span class="token operator">=</span> <span class="token function">defineEmits</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;is-typing&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;keydown-event&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;is-finished&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里的业务逻辑需要注意在页面切换的时候及时销毁定时器等，避免内存泄漏。</p><p>这三个模式中都有刷新文案的功能，逻辑是只用保证刷新时下一次结果不是当前的文案即可。 不过其中计时模式下的短句类型的刷新逻辑不一样，短句每次刷新是从数组中随机取其中五条，为此，我这里使用了 <code>Fisher-Yates 洗牌算法</code></p><h3 id="fisher-yates-洗牌算法" tabindex="-1"><a class="header-anchor" href="#fisher-yates-洗牌算法"><span>Fisher-Yates 洗牌算法</span></a></h3><p>该算法的核心思想是：</p><ul><li>从数组（或列表）的最后一个元素开始，向前遍历整个数组。</li><li>对于数组中的每一个元素（从最后一个元素开始直到第一个元素），生成一个介于当前索引（含）与数组末尾之间的随机索引。</li><li>用随机索引指向的元素与当前元素交换位置。</li><li>继续这个过程直到遍历到数组的第一个元素为止。</li></ul><p>对应的具体实现为</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> array <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>Sentence<span class="token punctuation">[</span>state<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;The array length should be at least 5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建一个包含原数组所有索引的数组</span>
  <span class="token keyword">const</span> indices <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> array<span class="token punctuation">.</span>length <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 使用 Fisher-Yates 洗牌算法打乱索引数组</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> indices<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> j <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> indices<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>indices<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 选取前 length 个随机索引，并从原数组中获取对应元素</span>
  <span class="token keyword">return</span> indices<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> array<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="上传文档" tabindex="-1"><a class="header-anchor" href="#上传文档"><span>上传文档</span></a></h3><p>自定义模式下<strong>上传文档</strong>可以细说一下。需要注意的是，前端自身是<strong>不具备</strong>直接解析或展示 .doc 等格式文档的能力的，目前只有 <code>.txt</code> 这种纯文本格式的内容可以读出来。所以借助 input file</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uploadFile<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">accept</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>.txt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@change</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handleFileChange<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>来读取 <code>.txt</code></p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">handleFileChange</span><span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> selectedFile <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedFile <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token string">&#39;text/plain&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>selectedFile<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> file <span class="token operator">=</span> selectedFile<span class="token punctuation">;</span>

    <span class="token comment">// 预览文本文件前 1000 个字符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;text/plain&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>selectedFile<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>customInfo <span class="token operator">=</span> reader<span class="token punctuation">.</span>result<span class="token operator">?.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        reader<span class="token punctuation">.</span><span class="token function">readAsText</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;请选择支持的文件类型!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="其他个性化功能逻辑" tabindex="-1"><a class="header-anchor" href="#其他个性化功能逻辑"><span>其他个性化功能逻辑</span></a></h2><h3 id="标点符号和空格的相互转换功能" tabindex="-1"><a class="header-anchor" href="#标点符号和空格的相互转换功能"><span>标点符号和空格的相互转换功能</span></a></h3><p>现在很多人的键盘输入场景都是在聊天框，一般会用空格来替代标点符号。所以这三种模式下都提供了标点符号和空格的相互转换功能，从而适合更多中国宝宝的打字习惯。</p><p>利用正则，将文案相互转换：</p><div class="language-tsx line-numbers-mode" data-ext="tsx" data-title="tsx"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">replacePunctuationWithSpace</span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> punctuationRegex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[.,;:!?(){}[\]\\/&#39;&quot;`“”‘’…—～，《》「」【】·、。！？；：]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gu</span></span><span class="token punctuation">;</span> <span class="token comment">// 匹配大多数常见标点符号</span>
  <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>punctuationRegex<span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连续空格替换为一个空格</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: yasinchan2016@gmail.com">yasinchan</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Ck2BnQe9.js" defer></script>
  </body>
</html>
